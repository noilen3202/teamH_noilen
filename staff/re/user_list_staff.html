<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€è¦§ï¼ˆè·å“¡ç”¨ï¼‰ - åœ°åŸŸæ”¯æ´ Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .main-header {
            background-color: #1e3a8a;
            color: white;
            padding: 1rem 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .content-card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .table-header {
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .data-row:hover {
            background-color: #fef3c7; /* Yellow hover effect for clarity */
        }
        .edit-button {
            transition: background-color 0.2s;
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">ãƒ¦ãƒ¼ã‚¶ãƒªã‚¹ãƒˆï¼ˆè·å“¡ç”¨ï¼‰</h1>
            <a href="/staff/menu" class="text-white hover:text-gray-300 transition duration-200 p-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-sm">
                <i class="fas fa-arrow-left mr-2"></i>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹
            </a>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-8">
        <h2 class="text-3xl font-extrabold text-gray-800 mb-6">ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆ</h2>
        
        <div class="content-card p-6 overflow-x-auto">
            <div class="mb-6 flex space-x-4">
                <input type="text" id="userSearch" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€IDã€ãƒ¡ãƒ¼ãƒ«ã§æ¤œç´¢" class="p-2 border border-gray-300 rounded-lg flex-grow focus:ring-amber-500 focus:border-amber-500">
                <button id="searchButton" class="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition duration-200">
                    <i class="fas fa-search mr-2"></i> æ¤œç´¢
                </button>
            </div>

            <table class="min-w-full divide-y divide-gray-200">
                <thead class="table-header">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">ID</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">æ°å</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                        <th class="px-6 py-3 text-center text-xs font-semibold uppercase tracking-wider">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="userListBody" class="bg-white divide-y divide-gray-200">
                    <tr><td colspan="6" class="p-4 text-center text-gray-500">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <footer class="mt-8 py-4 bg-gray-800 text-white text-center text-sm">
        <p>è·å“¡å°‚ç”¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹</p>
    </footer>

    <script>
        let allUsers = []; // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä¿æŒã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°

        // ----------------------------------------
        // ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
        // ----------------------------------------
        async function fetchUserList() {
            const body = document.getElementById('userListBody');
            body.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td></tr>';

            try {
                // ã€ä¿®æ­£æ¸ˆã¿ã€‘æ­£ã—ã„APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹
                const response = await fetch('/api/staff/users'); 
                
                if (response.ok) { // HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ200-299ã®å ´åˆï¼ˆæˆåŠŸï¼‰
                    const users = await response.json(); // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã®é…åˆ—ã‚’ç›´æ¥å–å¾—
                    allUsers = users; // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                    renderUserList(allUsers);
                } else {
                    // ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’JSONã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹ã‚’è©¦ã¿ã‚‹ï¼ˆã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ï¼‰
                    const errorData = await response.json().catch(() => ({ error: 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼å½¢å¼' }));
                    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆ.errorï¼‰ãŒã‚ã‚Œã°è¡¨ç¤ºã€ãªã‘ã‚Œã°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
                    const errorMessage = errorData.error || `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: ${response.status}`;
                    body.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-600">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${errorMessage}</td></tr>`;
                }

            } catch (error) {
                console.error('Fetch error:', error);
                body.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-600">ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚URLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</td></tr>`;
            }
        }

        // ----------------------------------------
        // ãƒªã‚¹ãƒˆã®æç”»
        // ----------------------------------------
        function renderUserList(users) {
            const body = document.getElementById('userListBody');
            body.innerHTML = '';
            
            if (users.length === 0) {
                body.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">è©²å½“ã™ã‚‹ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢ã¯ã„ã¾ã›ã‚“ã€‚</td></tr>';
                return;
            }

            users.forEach(user => {
                // ğŸš¨ ä¿®æ­£ç®‡æ‰€: ã“ã“ã« statusClass ã®å®šç¾©ã‚’è¿½åŠ ã—ã¾ã™ ğŸš¨
                const statusClass = user.status === 'active' ? 'bg-green-100 text-green-800' : 
                                    user.status === 'inactive' ? 'bg-red-100 text-red-800' : 
                                    'bg-yellow-100 text-yellow-800'; // statusã«å¿œã˜ãŸCSSã‚¯ãƒ©ã‚¹ã‚’æ±ºå®š

                const row = `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-6 py-3">${user.display_id || '-'}</td>
                        <td class="px-6 py-3 font-medium text-gray-900">${user.name}</td>
                        <td class="px-6 py-3 text-sm text-gray-500">${user.username}</td>
                        <td class="px-6 py-3 text-sm text-gray-500">${user.email || '-'}</td>
                        <td class="px-6 py-3">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                ${user.status_text}
                            </span>
                        </td>
                        <td class="px-6 py-3 text-right">
                            <a href="/staff/re/user_edit?id=${user.display_id}" class="text-indigo-600 hover:text-indigo-900 font-medium">ç·¨é›†</a>
                        </td>
                    </tr>
                `;
                body.innerHTML += row;
            });
        }

        // ----------------------------------------
        // æ¤œç´¢å‡¦ç†
        // ----------------------------------------
        function handleSearch() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            
            if (searchTerm === '') {
                renderUserList(allUsers);
                return;
            }

            const filteredUsers = allUsers.filter(user => 
                user.name.toLowerCase().includes(searchTerm) || 
                user.display_id.toString().includes(searchTerm) || // IDæ¤œç´¢å¯¾å¿œ
                user.email.toLowerCase().includes(searchTerm) ||
                user.username.toLowerCase().includes(searchTerm)
            );
            renderUserList(filteredUsers);
        }

        // ----------------------------------------
        // åˆæœŸãƒ­ãƒ¼ãƒ‰ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        // ----------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
            fetchUserList();
            
            // æ¤œç´¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            document.getElementById('userSearch').addEventListener('input', handleSearch);
            document.getElementById('searchButton').addEventListener('click', handleSearch);
        });
    </script>
</body>
</html>