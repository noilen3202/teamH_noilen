<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†ï¼ˆè·å“¡ç”¨ï¼‰ - åœ°åŸŸæ”¯æ´ Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .main-header {
            background-color: #1e3a8a;
            color: white;
            padding: 1rem 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .form-card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .input-field, .textarea-field, .select-field {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
            transition: border-color 0.2s;
        }
        .input-field:focus, .textarea-field:focus, .select-field:focus {
            border-color: #2563eb;
            outline: none;
        }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ç·¨é›†</h1>
            <a href="/staff/re/user_list" class="text-white hover:text-gray-300 transition duration-200">
                <i class="fas fa-arrow-left mr-1"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã¸æˆ»ã‚‹
            </a>
        </div>
    </header>

    <main class="max-w-4xl mx-auto py-8 px-4">
        <div id="loadingIndicator" class="text-center text-gray-500 hidden">
            <i class="fas fa-spinner fa-spin mr-2"></i>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...
        </div>

        <div id="formContainer" class="form-card p-6 md:p-8 hidden">
            <div class="mb-6 pb-4 border-b">
                <h2 id="userNameHeader" class="text-2xl font-semibold text-gray-800"></h2>
                <p class="text-sm text-gray-500 mt-1">ID: <span id="userIdDisplay"></span> | æ¨©é™: <span id="userRoleDisplay"></span></p>
            </div>
            
            <form id="userEditForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700 mb-1">ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼å (Username)</label>
                        <input type="text" id="username" name="username" class="input-field" disabled>
                    </div>
                    <div>
                        <label for="fullName" class="block text-sm font-medium text-gray-700 mb-1">æ°å/è¡¨ç¤ºå</label>
                        <input type="text" id="fullName" name="fullName" class="input-field" placeholder="ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢ã®æ°åã¾ãŸã¯è·å“¡ã®å½¹è·">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input type="email" id="email" name="email" class="input-field" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢ã®ã¿ï¼‰">
                    </div>
                    <div>
                        <label for="phoneNumber" class="block text-sm font-medium text-gray-700 mb-1">é›»è©±ç•ªå·</label>
                        <input type="tel" id="phoneNumber" name="phoneNumber" class="input-field" placeholder="é›»è©±ç•ªå·ï¼ˆãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢ã®ã¿ï¼‰">
                    </div>
                    <div id="birthYearField" class="hidden">
                        <label for="birthYear" class="block text-sm font-medium text-gray-700 mb-1">ç”Ÿå¹´</label>
                        <input type="number" id="birthYear" name="birthYear" class="input-field" min="1900" max="2100" placeholder="ä¾‹: 1980">
                    </div>
                    <div id="genderField" class="hidden">
                        <label for="gender" class="block text-sm font-medium text-gray-700 mb-1">æ€§åˆ¥</label>
                        <select id="gender" name="gender" class="select-field">
                            <option value="Unspecified">æœªæŒ‡å®š</option>
                            <option value="Male">ç”·æ€§</option>
                            <option value="Female">å¥³æ€§</option>
                            <option value="Other">ãã®ä»–</option>
                        </select>
                    </div>
                </div>

                <div id="addressSection" class="hidden">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 border-t pt-4">ä½æ‰€æƒ…å ±ï¼ˆãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢ã®ã¿ï¼‰</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="postalCode" class="block text-sm font-medium text-gray-700 mb-1">éƒµä¾¿ç•ªå·</label>
                            <input type="text" id="postalCode" name="postalCode" class="input-field" placeholder="ä¾‹: 123-4567">
                        </div>
                        <div class="md:col-span-2">
                            <label for="address" class="block text-sm font-medium text-gray-700 mb-1">ä½æ‰€</label>
                            <textarea id="address" name="address" rows="2" class="textarea-field" placeholder="å¸‚åŒºç”ºæ‘ä»¥é™ã®ä½æ‰€"></textarea>
                        </div>
                    </div>
                </div>

                <div id="staffRoleSection" class="hidden">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 border-t pt-4">è·å“¡æ¨©é™ï¼ˆè·å“¡ã®ã¿ï¼‰</h3>
                    <div class="mb-6">
                        <label for="staffRole" class="block text-sm font-medium text-gray-700 mb-1">æ¨©é™ãƒ¬ãƒ™ãƒ«</label>
                        <select id="staffRole" name="staffRole" class="select-field">
                            <option value="Staff">ä¸€èˆ¬è·å“¡ (Staff)</option>
                            <option value="OrgAdmin">çµ„ç¹”ç®¡ç†è€… (OrgAdmin)</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">çµ„ç¹”ç®¡ç†è€…(OrgAdmin)ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚„ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã®å…¨ã¦ã®æ¨©é™ã‚’æŒã¡ã¾ã™ã€‚</p>
                    </div>
                </div>

                <div class="border-t pt-6 mt-6 flex justify-between items-center">
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-200 shadow-md">
                        å¤‰æ›´ã‚’ä¿å­˜
                    </button>
                    <button type="button" id="deleteAccountButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-6 rounded-lg transition duration-200 shadow-md">
                        ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤
                    </button>
                </div>
            </form>
        </div>
    </main>

    <script>
    let currentUserId = null; // ç¾åœ¨ç·¨é›†ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
    let isStaff = false;
    let userName = ''; // å‰Šé™¤ç¢ºèªç”¨

    // ----------------------------------------
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®ãƒ­ãƒ¼ãƒ‰
    // ----------------------------------------
    async function loadUserData(userId) {
        currentUserId = userId;
        const loading = document.getElementById('loadingIndicator');
        const formContainer = document.getElementById('formContainer');
        loading.classList.remove('hidden');
        formContainer.classList.add('hidden');

        try {
            const response = await fetch(`/api/user/${userId}`);
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼' }));
                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
            }

            const user = await response.json();
            isStaff = user.is_org_staff;
            userName = user.name || user.username;

            // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
            document.getElementById('userNameHeader').textContent = userName;
            document.getElementById('userIdDisplay').textContent = user.id;
            document.getElementById('userRoleDisplay').textContent = isStaff ? (user.role === 'OrgAdmin' ? 'çµ„ç¹”ç®¡ç†è€…' : 'ä¸€èˆ¬è·å“¡') : 'ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢';
            
            document.getElementById('username').value = user.username || '';
            document.getElementById('fullName').value = user.full_name || '';
            document.getElementById('email').value = user.email || '';
            document.getElementById('phoneNumber').value = user.phone_number || '';
            
            // ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢/è·å“¡ã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            if (isStaff) {
                // è·å“¡ã®å ´åˆ
                document.getElementById('birthYearField').classList.add('hidden');
                document.getElementById('genderField').classList.add('hidden');
                document.getElementById('addressSection').classList.add('hidden');
                document.getElementById('staffRoleSection').classList.remove('hidden');
                document.getElementById('staffRole').value = user.role || 'Staff';

                // è·å“¡ã¯æ°å/è¡¨ç¤ºåã‚’roleã§ç®¡ç†ã—ã¦ã„ã‚‹ãŸã‚ã€fullNameãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç„¡åŠ¹åŒ–
                document.getElementById('fullName').disabled = true;

            } else {
                // ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢ã®å ´åˆ
                document.getElementById('birthYearField').classList.remove('hidden');
                document.getElementById('genderField').classList.remove('hidden');
                document.getElementById('addressSection').classList.remove('hidden');
                document.getElementById('staffRoleSection').classList.add('hidden');

                document.getElementById('birthYear').value = user.birth_year || '';
                document.getElementById('gender').value = user.gender || 'Unspecified';
                document.getElementById('postalCode').value = user.postal_code || '';
                document.getElementById('address').value = user.address || '';
                
                document.getElementById('fullName').disabled = false;
            }

            loading.classList.add('hidden');
            formContainer.classList.remove('hidden');

        } catch (error) {
            console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
            alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            // å¤±æ•—ã—ãŸå ´åˆã‚‚ä¸€è¦§ç”»é¢ã«æˆ»ã‚‹
            window.location.href = '/staff/re/user_list'; 
        }
    }

    // ----------------------------------------
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®ä¿å­˜ (å®Ÿè£…)
    // ----------------------------------------
    async function saveUserData(event) {
        event.preventDefault();

        if (!currentUserId) {
            alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒä¸æ˜ã§ã™ã€‚');
            return;
        }

        // ... (ãƒ‡ãƒ¼ã‚¿ã®åé›†ãƒ­ã‚¸ãƒƒã‚¯ã¯çœç•¥)
        const formElement = document.getElementById('userEditForm');
        const formData = new FormData(formElement);
        const data = {
            is_org_staff: isStaff,
        };
        
        // ãƒ‡ãƒ¼ã‚¿ã‚’JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¾ã¨ã‚ã‚‹
        data.email = formData.get('email');
        data.phoneNumber = formData.get('phoneNumber');

        if (isStaff) {
            data.staffRole = formData.get('staffRole');
        } else {
            data.fullName = formData.get('fullName');
            data.birthYear = formData.get('birthYear') ? parseInt(formData.get('birthYear')) : null;
            data.gender = formData.get('gender');
            data.postalCode = formData.get('postalCode');
            data.address = formData.get('address');
        }
        
        // ã‚µãƒ¼ãƒãƒ¼ã¸PUTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
        try {
            const response = await fetch(`/api/user/${currentUserId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const responseData = await response.json();

            if (response.ok) {
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒæ­£å¸¸ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚');
                
                // ğŸš¨ ä¿®æ­£ç®‡æ‰€: æ›´æ–°æˆåŠŸå¾Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ç”»é¢ã«é·ç§»ã—ã¾ã™ ğŸš¨
                window.location.href = '/staff/re/user_list'; 
                
            } else {
                alert(`ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ${responseData.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
                console.error('Update failed:', responseData);
            }

        } catch (error) {
            console.error('Fetch error:', error);
            alert('ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
    }
    // ----------------------------------------
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å‰Šé™¤
    // ----------------------------------------
    async function deleteUserAccount() {
        if (!confirm(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userName} ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
            return;
        }
        
        try {
            // DELETE APIã®å‘¼ã³å‡ºã—ï¼ˆæœªå®Ÿè£…ã‚’æƒ³å®šã€‚ã‚µãƒ¼ãƒãƒ¼å´ã§åˆ¥é€”DELETEã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå¿…è¦ã§ã™ï¼‰
            const response = await fetch(`/api/user/${currentUserId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (response.ok && data.success) { // DELETEæˆåŠŸæ™‚ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
                alert(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userName} ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æ­£å¸¸ã«å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
                // æˆåŠŸå¾Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ç”»é¢ã¸é·ç§»
                window.location.href = '/staff/re/user_list'; 
            } else {
                alert(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${data.error || data.message}`);
            }
        } catch (error) {
            console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
            alert('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚Šã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
        }
    }
    // ğŸš¨ ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã®å‡¦ç†ã“ã“ã¾ã§ ğŸš¨

    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸå‡¦ç†
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('id'); 
        
        if (userId) {
            loadUserData(userId);
        } else {
            // è·å“¡ç®¡ç†ç”»é¢ã‹ã‚‰é·ç§»ã™ã‚‹éš›ã¯IDå¿…é ˆ
            alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä¸€è¦§ç”»é¢ã«æˆ»ã‚Šã¾ã™ã€‚');
            window.location.href = '/staff/re/user_list'; 
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ã¨å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        document.getElementById('userEditForm').addEventListener('submit', saveUserData);
        const deleteButton = document.getElementById('deleteAccountButton');
        if (deleteButton) {
            deleteButton.addEventListener('click', deleteUserAccount);
        }
    });
</script>
</body>
</html>