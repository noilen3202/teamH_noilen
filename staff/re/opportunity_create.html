<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹Ÿé›†ä½œæˆ - åœ°åŸŸæ”¯æ´ Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .main-header {
            background-color: #1e3a8a;
            color: white;
            padding: 1rem 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .form-card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .input-field, .textarea-field, .select-field {
            border: 1px solid #d1d5db;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus, .textarea-field:focus, .select-field:focus {
            border-color: #2563eb; /* Blue focus */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
            outline: none;
        }
        .required-label:after { 
            content: " *"; 
            color: #ef4444; 
        }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">
                <i class="fas fa-bullhorn mr-2"></i>ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢å‹Ÿé›†ä½œæˆ (DBç™»éŒ²é …ç›®ã®ã¿)
            </h1>
            <a href="/staff/menu" class="text-white hover:text-gray-300 transition duration-200 p-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-sm">
                <i class="fas fa-arrow-left mr-2"></i>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹
            </a>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 md:p-8">

        <div class="form-card p-6 md:p-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">å‹Ÿé›†æ¡ˆä»¶ æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ </h2>
            <p class="text-sm text-gray-500 mb-6">â€» ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ç›´æ¥ç™»éŒ²ã•ã‚Œã‚‹å¿…é ˆé …ç›®ã®ã¿ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚</p>

            <form id="opportunityForm">

                <fieldset class="border border-gray-200 p-4 rounded-lg mb-6">
                    <legend class="text-lg font-semibold text-gray-700 px-2">1. æ¡ˆä»¶åŸºæœ¬æƒ…å ±</legend>

                    <div class="mb-4">
                        <label for="title" class="block text-sm font-medium text-gray-700 mb-2 required-label">å‹Ÿé›†ã‚¿ã‚¤ãƒˆãƒ«</label>
                        <input type="text" id="title" name="title" class="input-field" placeholder="Recruitments.title" required>
                    </div>

                    <div class="mb-4">
                        <label for="description" class="block text-sm font-medium text-gray-700 mb-2 required-label">å‹Ÿé›†è©³ç´°</label>
                        <textarea id="description" name="description" rows="6" class="textarea-field" placeholder="Recruitments.description" required></textarea>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠ</label>
                        <div id="category-checkboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-4 p-4 border border-gray-200 rounded-lg bg-gray-50">
                            <p class="text-sm text-gray-500">ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                        </div>
                    </div>
                </fieldset>

                <fieldset class="border border-gray-200 p-4 rounded-lg mb-6">
                    <legend class="text-lg font-semibold text-gray-700 px-2">2. æ´»å‹•æ—¥æ™‚ã¨å‹Ÿé›†æœŸé–“</legend>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="activity_date" class="block text-sm font-medium text-gray-700 mb-2 required-label">æ´»å‹•é–‹å§‹æ—¥ (Recruitments.start_date)</label>
                            <input type="date" id="activity_date" name="activity_date" class="input-field" required>
                        </div>
                        <div>
                            <label for="deadline" class="block text-sm font-medium text-gray-700 mb-2 required-label">å‹Ÿé›†ç· åˆ‡æ—¥ (Recruitments.end_date)</label>
                            <input type="date" id="deadline" name="deadline" class="input-field" required>
                        </div>
                    </div>
                </fieldset>
                
                <fieldset class="border border-gray-200 p-4 rounded-lg mb-6">
                    <legend class="text-lg font-semibold text-gray-700 px-2">3. é€£çµ¡å…ˆãƒ»å…¬é–‹è¨­å®š</legend>

                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-2 required-label">æ‹…å½“è€…é€£çµ¡ç”¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ (Recruitments.contact_email)</label>
                        <input type="email" id="email" name="email" class="input-field" placeholder="ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢ã‹ã‚‰ã®å•ã„åˆã‚ã›ãŒå±Šããƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" required>
                    </div>

                    <div class="mb-4">
                        <label for="phone_number" class="block text-sm font-medium text-gray-700 mb-2">æ‹…å½“è€…é€£çµ¡ç”¨é›»è©±ç•ªå· (Recruitments.contact_phone_number)</label>
                        <input type="tel" id="phone_number" name="phone_number" class="input-field" placeholder="ä¾‹: 090-1234-5678 (ä»»æ„)">
                        <p class="text-xs text-gray-500 mt-1">å…¬é–‹ã•ã‚Œã‚‹é€£çµ¡å…ˆã¨ãªã‚Šã¾ã™ã€‚</p>
                    </div>

                    <div class="mt-6">
                        <label for="status" class="block text-sm font-medium text-gray-700 mb-2 required-label">å…¬é–‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (Recruitments.status)</label>
                        <select id="status" name="status" class="select-field" required>
                            <option value="draft">ä¸‹æ›¸ã (éå…¬é–‹)</option>
                            <option value="published">å…¬é–‹ (ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢ã«å³æ™‚è¡¨ç¤º)</option>
                        </select>
                    </div>
                </fieldset>

                <div class="mt-8 flex space-x-4">
                    <button type="button" id="submitDraft" class="flex-1 bg-gray-500 text-white py-3 rounded-lg font-semibold text-lg hover:bg-gray-600 transition duration-300 shadow-lg">
                        <i class="fas fa-save mr-2"></i>ä¸‹æ›¸ãã¨ã—ã¦ä¿å­˜
                    </button>
                    <button type="submit" id="submitPublish" class="flex-1 bg-blue-700 text-white py-3 rounded-lg font-semibold text-lg hover:bg-blue-800 transition duration-300 shadow-lg">
                        <i class="fas fa-arrow-right mr-2"></i>å…¬é–‹ã—ã¦ç™»éŒ²
                    </button>
                </div>
            </form>
        </div>
    </main>

    <script>
        const form = document.getElementById('opportunityForm');
        const categoryCheckboxesDiv = document.getElementById('category-checkboxes');
        const submitDraftButton = document.getElementById('submitDraft');
        
        // ------------------------------------------------------------------
        // ã‚«ãƒ†ã‚´ãƒªãƒ¼ä¸€è¦§ã®å–å¾—ã¨è¡¨ç¤º 
        // ------------------------------------------------------------------
        async function loadCategories() {
            try {
                const response = await fetch('/api/categories'); 
                if (!response.ok) throw new Error('ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                const categories = await response.json();
                
                categoryCheckboxesDiv.innerHTML = ''; 

                categories.forEach(category => {
                    const checkboxContainer = document.createElement('div');
                    checkboxContainer.className = 'flex items-center';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `category-${category.category_id}`;
                    checkbox.name = 'categories';
                    checkbox.value = category.category_id;
                    checkbox.className = 'w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500';
                    const label = document.createElement('label');
                    label.htmlFor = `category-${category.category_id}`;
                    label.className = 'ml-2 text-sm font-medium text-gray-700 cursor-pointer';
                    label.textContent = category.category_name;

                    checkboxContainer.appendChild(checkbox);
                    checkboxContainer.appendChild(label);
                    categoryCheckboxesDiv.appendChild(checkboxContainer);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
                categoryCheckboxesDiv.innerHTML = `<p class="text-sm text-red-500">ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>`;
            }
        }
        
        loadCategories();

        // ------------------------------------------------------------------
        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç† (APIã«é€ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’æœ€å°åŒ–)
        // ------------------------------------------------------------------
        async function submitOpportunity(status) {
            const selectedCategories = Array.from(document.querySelectorAll('input[name="categories"]:checked')).map(cb => cb.value);

            // DBç™»éŒ²é …ç›®ã¨ã€server.pyã®APIãŒå¿…é ˆã¨ã™ã‚‹é …ç›®ã‚’formDataã«å«ã‚ã¾ã™
            const formData = {
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                categories: selectedCategories,
                activity_date: document.getElementById('activity_date').value,
                deadline: document.getElementById('deadline').value,
                email: document.getElementById('email').value,
                // ğŸ“ ã“ã“ã§é›»è©±ç•ªå·ã‚’å–å¾—
                phone_number: document.getElementById('phone_number').value || null, // å€¤ãŒç©ºã®å ´åˆã¯nullã‚’é€ä¿¡
                status: status,
                
                // server.pyã®APIãŒå¿…é ˆã¨ã—ã¦ã„ã‚‹ãŒãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰å‰Šé™¤ã—ãŸé …ç›®ã¯ä»®ã®å€¤ã§é€ä¿¡ (APIå´ã§å‡¦ç†ã•ã‚Œã‚‹)
                location: 'æœªæŒ‡å®š', 
                required_count: 1, 
                time_frame: null,
                required_skills: null, 
            };

            // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ç°¡æ˜“ãƒã‚§ãƒƒã‚¯
            if (!formData.title || !formData.description || !formData.activity_date || !formData.deadline || !formData.email) {
                alert('å‹Ÿé›†ã‚¿ã‚¤ãƒˆãƒ«ã€å‹Ÿé›†è©³ç´°ã€æ´»å‹•é–‹å§‹æ—¥ã€å‹Ÿé›†ç· åˆ‡æ—¥ã€æ‹…å½“è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¿…é ˆã§ã™ã€‚');
                return;
            }

            try {
                const response = await fetch('/staff/api/opportunities', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                });

                const result = await response.json();

                if (response.ok) {
                    alert(result.message);
                    window.location.href = '/staff/recruitment/list'; 
                } else {
                    alert(`ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ${result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
                }
            } catch (error) {
                console.error('Fetch error:', error);
                alert('é€šä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            }
        }

        // ------------------------------------------------------------------
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        // ------------------------------------------------------------------
        // ã€Œä¸‹æ›¸ãã¨ã—ã¦ä¿å­˜ã€
        submitDraftButton.addEventListener('click', (event) => {
            event.preventDefault();
            submitOpportunity('draft');
        });

        // ã€Œå…¬é–‹ã—ã¦ç™»éŒ²ã€
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            submitOpportunity('published');
        });
        
    </script>
</body>
</html>